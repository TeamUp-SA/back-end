# ===================================================================
#  STORAGE: Persistent Volume Claims
# ===================================================================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-pvc
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests: { storage: 1Gi }
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: redis-pvc
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests: { storage: 1Gi }

# ===================================================================
#  DATABASE: PostgreSQL
# ===================================================================
---
apiVersion: v1
kind: Service
metadata:
  name: postgres-svc
spec:
  type: ClusterIP
  ports: [{ port: 5432, targetPort: 5432 }]
  selector: { app: postgres }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-deployment
spec:
  replicas: 1
  selector:
    matchLabels: { app: postgres }
  template:
    metadata:
      labels: { app: postgres }
    spec:
      containers:
        - name: postgres
          image: postgres:15
          imagePullPolicy: IfNotPresent
          ports: [{ containerPort: 5432 }]
          envFrom: [{ secretRef: { name: postgres-secret } }]
          readinessProbe:
            exec:
              command:
                ["pg_isready", "-U", "$(POSTGRES_USER)", "-d", "$(POSTGRES_DB)"]
            initialDelaySeconds: 10
            periodSeconds: 5
          volumeMounts:
            - name: postgres-storage
              mountPath: /var/lib/postgresql/data
            - name: postgres-init-scripts
              mountPath: /docker-entrypoint-initdb.d
      volumes:
        - name: postgres-storage
          persistentVolumeClaim: { claimName: postgres-pvc }
        - name: postgres-init-scripts
          configMap: { name: postgres-init-sql-cm }

# ===================================================================
#  CACHE: Redis
# ===================================================================
---
apiVersion: v1
kind: Service
metadata:
  name: redis-svc
spec:
  type: ClusterIP
  ports: [{ port: 6379, targetPort: 6379 }]
  selector: { app: redis }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-deployment
spec:
  replicas: 1
  selector:
    matchLabels: { app: redis }
  template:
    metadata:
      labels: { app: redis }
    spec:
      containers:
        - name: redis
          image: redis:7-alpine
          imagePullPolicy: IfNotPresent
          ports: [{ containerPort: 6379 }]
          volumeMounts:
            - name: redis-storage
              mountPath: /data
      volumes:
        - name: redis-storage
          persistentVolumeClaim: { claimName: redis-pvc }

# ===================================================================
# Â MESSAGING: Zookeeper (Corrected Readiness Probe)
# ===================================================================
---
apiVersion: v1
kind: Service
metadata:
  name: zookeeper-svc
spec:
  type: ClusterIP
  ports:
    - name: zookeeper-port
      port: 2181
      targetPort: 2181
  selector:
    app: zookeeper
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: zookeeper-deployment
spec:
  replicas: 1
  selector:
    matchLabels: { app: zookeeper }
  template:
    metadata:
      labels: { app: zookeeper }
    spec:
      containers:
        - image: wurstmeister/zookeeper
          imagePullPolicy: IfNotPresent
          name: zookeeper
          ports:
            - containerPort: 2181

# ===================================================================
# Â MESSAGING: Kafka (Matching wurstmeister/kafka config)
# ===================================================================
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: kafka
  name: kafka-svc
spec:
  ports:
    - port: 9092
  selector:
    app: kafka
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kafka-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kafka
  template:
    metadata:
      labels:
        app: kafka
    spec:
      hostname: kafka
      containers:
        - env:
            - name: KAFKA_BROKER_ID
              value: "1"
            - name: KAFKA_ZOOKEEPER_CONNECT
              value: zookeeper-svc:2181
            - name: KAFKA_LISTENERS
              value: PLAINTEXT://:9092
            - name: KAFKA_ADVERTISED_LISTENERS
              value: PLAINTEXT://kafka-svc:9092
          image: wurstmeister/kafka
          imagePullPolicy: IfNotPresent
          name: kafka
          ports:
            - containerPort: 9092

# ===================================================================
#  CORE: User Service
# ===================================================================
---
apiVersion: v1
kind: Service
metadata:
  name: user-service-svc
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 8081
      targetPort: 8081
    - name: grpc
      port: 9091
      targetPort: 9091
  selector: { app: user-service }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: user-service-deployment
spec:
  replicas: 1
  selector:
    matchLabels: { app: user-service }
  template:
    metadata:
      labels: { app: user-service }
    spec:
      initContainers:
        - name: wait-for-postgres
          image: busybox:1.36
          command:
            [
              "sh",
              "-c",
              'until nc -z postgres-svc 5432; do echo "waiting for postgres"; sleep 2; done;',
            ]
        - name: wait-for-redis
          image: busybox:1.36
          command:
            [
              "sh",
              "-c",
              'until nc -z redis-svc 6379; do echo "waiting for redis"; sleep 2; done;',
            ]
      containers:
        - name: user-service
          image: user-service:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8081
            - containerPort: 9091
          envFrom: [{ secretRef: { name: user-service-secret } }]

# ===================================================================
#  CORE: Auth Service
# ===================================================================
---
apiVersion: v1
kind: Service
metadata:
  name: auth-service-svc
spec:
  type: NodePort
  selector:
    app: auth-service
  ports:
    - port: 8082
      targetPort: 8082
      nodePort: 30082
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service-deployment
spec:
  replicas: 1
  selector:
    matchLabels: { app: auth-service }
  template:
    metadata:
      labels: { app: auth-service }
    spec:
      initContainers:
        - name: wait-for-user-service
          image: busybox:1.36
          command:
            [
              "sh",
              "-c",
              'until nc -z user-service-svc 8081; do echo "waiting for user-service"; sleep 2; done;',
            ]
        - name: wait-for-redis
          image: busybox:1.36
          command:
            [
              "sh",
              "-c",
              'until nc -z redis-svc 6379; do echo "waiting for redis"; sleep 2; done;',
            ]
      containers:
        - name: auth-service
          image: auth-service:latest
          imagePullPolicy: IfNotPresent
          ports: [{ containerPort: 8082 }]
          envFrom: [{ secretRef: { name: auth-service-secret } }]

# ===================================================================
#  CORE: Notification Service
# ===================================================================
---
apiVersion: v1
kind: Service
metadata:
  name: notification-service-svc
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 8083
      targetPort: 8083
    - name: internal-rpc
      port: 9999
      targetPort: 9999
  selector: { app: notification-service }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: notification-service-deployment
spec:
  replicas: 1
  selector:
    matchLabels: { app: notification-service }
  template:
    metadata:
      labels: { app: notification-service }
    spec:
      initContainers:
        - name: wait-for-kafka
          image: wurstmeister/kafka
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - |
              BROKER="kafka-svc:9092"
              TEMP_TOPIC="notifications"
              TEMP_GROUP="init-check-group"

              # 1. Wait for the broker to be available
              echo "Waiting for Kafka broker ($BROKER) to be ready..."
              until /opt/kafka/bin/kafka-topics.sh --bootstrap-server $BROKER --list 2>/dev/null; do
                echo "Broker not reachable yet. Retrying in 2 seconds..."
                sleep 2
              done
              echo "Broker is reachable."

              # ðŸ’¡ NEW STEP: Give the broker time to establish internal readiness (Zookeeper sync)
              echo "Pausing for 5 seconds to allow broker leadership election..."
              sleep 5

              # 2. Trigger the creation of __consumer_offsets and 'notifications' topic
              echo "Triggering creation of internal topics..."
              /opt/kafka/bin/kafka-console-consumer.sh \
                --bootstrap-server $BROKER \
                --topic $TEMP_TOPIC \
                --from-beginning \
                --timeout-ms 5000 \
                --max-messages 1 \
                --consumer-property group.id=$TEMP_GROUP

              echo "Kafka readiness checks complete. Starting main container."
      containers:
        - name: notification-service
          image: notification-service:latest
          imagePullPolicy: IfNotPresent
          ports:
            - { containerPort: 8083 }
            - { containerPort: 9999 }
          envFrom: [{ secretRef: { name: notification-service-secret } }]

# ===================================================================
#  CORE: App Service
# ===================================================================
---
apiVersion: v1
kind: Service
metadata:
  name: app-service-svc
spec:
  type: ClusterIP
  ports: [{ port: 3001, targetPort: 3001 }]
  selector: { app: app-service }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-service-deployment
spec:
  replicas: 1
  selector:
    matchLabels: { app: app-service }
  template:
    metadata:
      labels: { app: app-service }
    spec:
      initContainers:
        - name: wait-for-kafka
          image: wurstmeister/kafka
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - |
              BROKER="kafka-svc:9092"
              echo "Waiting for Kafka broker ($BROKER) to be available..."
              # FIX: Only wait for the broker to be reachable, not for a specific topic to exist.
              until /opt/kafka/bin/kafka-topics.sh --bootstrap-server $BROKER --list 2>/dev/null; do
                echo "Kafka broker not ready. Retrying in 2 seconds..."
                sleep 2
              done
              echo "Kafka broker is ready."
        - name: wait-for-notification
          image: busybox:1.36
          command:
            - sh
            - -c
            - 'until nc -z notification-service-svc 9999; do echo "waiting for notification"; sleep 2; done;'
      containers:
        - name: app-service
          image: app-service:latest
          imagePullPolicy: IfNotPresent
          ports: [{ containerPort: 3001 }]
          envFrom: [{ secretRef: { name: app-service-secret } }]

# ===================================================================
#  GATEWAY: Krakend
# ===================================================================
---
apiVersion: v1
kind: Service
metadata:
  name: krakend-svc
spec:
  type: NodePort
  ports:
    - name: http
      port: 8888
      targetPort: 8888
      nodePort: 30011
  selector: { app: krakend }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: krakend-deployment
spec:
  replicas: 1
  selector:
    matchLabels: { app: krakend }
  template:
    metadata:
      labels: { app: krakend }
    spec:
      containers:
        - name: krakend
          image: devopsfaith/krakend:latest
          imagePullPolicy: IfNotPresent
          args: ["run", "-c", "/etc/krakend/krakend.json"]
          ports: [{ containerPort: 8888 }]
          volumeMounts:
            - name: krakend-config-volume
              mountPath: /etc/krakend
      volumes:
        - name: krakend-config-volume
          configMap: { name: krakend-config-cm }
# ===================================================================
#  CORE: Search Service
# ===================================================================
---
apiVersion: v1
kind: Service
metadata:
  name: search-service-svc
spec:
  type: ClusterIP
  ports:
    - port: 4000
      targetPort: 4000
  selector:
    app: search-service
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: search-service-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: search-service
  template:
    metadata:
      labels:
        app: search-service
    spec:
      initContainers:
        - name: wait-for-app-service
          image: busybox:1.36
          command:
            - sh
            - -c
            - 'until nc -z app-service-svc 3001; do echo "waiting for app-service"; sleep 2; done;'
        - name: wait-for-user-service
          image: busybox:1.36
          command:
            - sh
            - -c
            - 'until nc -z user-service-svc 8081; do echo "waiting for user-service"; sleep 2; done;'
      containers:
        - name: search-service
          image: search-service:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 4000
          envFrom:
            - secretRef:
                name: search-service-secret
